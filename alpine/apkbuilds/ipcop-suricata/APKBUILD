# Maintainer: IPCop Development Team <ipcop-dev@lists.sourceforge.net>
pkgname=ipcop-suricata
pkgver=2.2.0
pkgrel=1
pkgdesc="IPCop IDS (Suricata)"
url="https://www.ipcop.org"
arch="all"
license="GPL"
depends="ipcop-core suricata"
replaces="suricata-openrc"
install="$pkgname.post-install"
builddir="$startdir/../../.."

build() {
    if [ -d "source/services/suricata/progs" ]; then
        cd "$builddir/source/services/suricata/progs"
        make restartsuricata || return 1
    fi
}

package() {
	cd "$builddir"
    
    # Install Helper
    install -d "$pkgdir"/usr/bin
    if [ -f "source/services/suricata/progs/restartsuricata" ]; then
        install -m 4750 -g lighttpd source/services/suricata/progs/restartsuricata "$pkgdir"/usr/bin/
    fi

    install -d "$pkgdir"/var/www/ipcop/cgi-bin
    install -m 0755 source/services/suricata/html/cgi-bin/*.cgi "$pkgdir"/var/www/ipcop/cgi-bin/
    
    install -d "$pkgdir"/var/ipcop
    # Install Initial Configuration (Hierarchy)
    if [ -d "source/services/suricata/var/ipcop" ]; then
        cp -r source/services/suricata/var/ipcop/* "$pkgdir"/var/ipcop/
    fi
    
    install -d "$pkgdir"/etc/conf.d
    cat > "$pkgdir"/etc/conf.d/suricata <<EOF
# IPCop Suricata Configuration Override
SURICATA_OPTS="-c /var/ipcop/suricata/suricata.yaml -i eth0"
EOF
    chmod 644 "$pkgdir"/etc/conf.d/suricata
    
    install -d "$pkgdir"/var/log/suricata
    chown -R root:lighttpd "$pkgdir"/var/log/suricata
    
    # Enforce permissions
    chown -R root:lighttpd "$pkgdir"/var/ipcop
    chmod -R u=rwX,g=rwX,o= "$pkgdir"/var/ipcop
    find "$pkgdir"/var/ipcop -type f -exec chmod -x {} +
}
