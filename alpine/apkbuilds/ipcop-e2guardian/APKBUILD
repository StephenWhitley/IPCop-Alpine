# Maintainer: IPCop Development Team <ipcop-dev@lists.sourceforge.net>
pkgname=ipcop-e2guardian
pkgver=2.2.0
pkgrel=1
pkgdesc="IPCop Firewall - Web Content Filter"
url="https://www.ipcop.org"
arch="noarch"
license="GPL-2.0-or-later"
options="!check"
install="$pkgname.post-install"
depends="ipcop-core e2guardian"
makedepends="dos2unix"

builddir="$startdir/../../.."

build() { :; }

package() {
	cd "$builddir"
    install -d "$pkgdir"/var/www/ipcop/cgi-bin
    install -m 0755 source/services/e2guardian/html/cgi-bin/*.cgi "$pkgdir"/var/www/ipcop/cgi-bin/
    
    install -d "$pkgdir"/var/ipcop
    # Install Initial Configuration (Hierarchy)
    if [ -d "source/services/e2guardian/var/ipcop" ]; then
        cp -r source/services/e2guardian/var/ipcop/* "$pkgdir"/var/ipcop/
    fi
    
    # Install E2Guardian configuration if present in source/services/e2guardian/etc
    if [ -d "source/services/e2guardian/etc" ]; then
        cp -r source/services/e2guardian/etc/* "$pkgdir"/etc/
    fi
    
    install -d "$pkgdir"/etc/conf.d
    cat > "$pkgdir"/etc/conf.d/e2guardian <<EOF
# IPCop E2Guardian Configuration Override
E2GUARDIAN_OPTS="-c /var/ipcop/proxy/e2guardian.conf"
EOF
    chmod 644 "$pkgdir"/etc/conf.d/e2guardian
    # Enforce permissions
    chown -R root:lighttpd "$pkgdir"/var/ipcop
    chmod -R u=rwX,g=rwX,o= "$pkgdir"/var/ipcop
    find "$pkgdir"/var/ipcop -type f -exec chmod -x {} +
}
