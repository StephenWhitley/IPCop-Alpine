# Maintainer: IPCop Development Team <ipcop-dev@lists.sourceforge.net>
pkgname=ipcop-squid
pkgver=2.2.0
pkgrel=2
pkgdesc="IPCop Firewall - Web Proxy (Squid)"
url="https://www.ipcop.org"
arch="all"
license="GPL-2.0-or-later"
options="!check"
install="$pkgname.post-install"
depends="ipcop-core squid"
makedepends="dos2unix"

builddir="$startdir/../../.."

build() {
    if [ -d "source/services/squid/progs" ]; then
        cd "$builddir/source/services/squid/progs"
        make restartsquid || return 1
    fi
}

package() {
	cd "$builddir"
    
    # Install Helper
    install -d "$pkgdir"/usr/bin
    if [ -f "source/services/squid/progs/restartsquid" ]; then
        install -m 4750 -g lighttpd source/services/squid/progs/restartsquid "$pkgdir"/usr/bin/
    fi

    install -d "$pkgdir"/var/www/ipcop/cgi-bin
    install -m 0755 source/services/squid/html/cgi-bin/*.cgi "$pkgdir"/var/www/ipcop/cgi-bin/
    
    install -d "$pkgdir"/var/ipcop
    # Install Initial Configuration (Hierarchy)
    if [ -d "source/services/squid/var/ipcop" ]; then
        cp -r source/services/squid/var/ipcop/* "$pkgdir"/var/ipcop/
    fi
    
    install -d "$pkgdir"/etc/conf.d
    cat > "$pkgdir"/etc/conf.d/squid <<EOF
# IPCop Squid Configuration Override
command_args="-f /var/ipcop/proxy/squid.conf"
EOF
    chmod 644 "$pkgdir"/etc/conf.d/squid
    
    install -d "$pkgdir"/var/log/squid
    chown -R root:lighttpd "$pkgdir"/var/log/squid
    install -d "$pkgdir"/var/ipcop/proxy
    
    # Enforce permissions
    chown -R root:lighttpd "$pkgdir"/var/ipcop
    chmod -R u=rwX,g=rwX,o= "$pkgdir"/var/ipcop
    find "$pkgdir"/var/ipcop -type f -exec chmod -x {} +
    
    install -d "$pkgdir"/var/log/squid
    chown -R root:lighttpd "$pkgdir"/var/log/squid
}
